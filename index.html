<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smartwatch Health Monitor</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 15px; }
        .section { margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 12px; }
        .data-display { font-size: 24px; margin: 15px 0; padding: 10px; background: white; border-radius: 8px; }
        #debug-console { background: #1a1a1a; color: #00ff00; padding: 10px; font-family: monospace; border-radius: 8px; }
        button { padding: 12px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="section">
        <button id="connectBtn">Connect Device</button>
        <button id="spo2Btn" disabled>Take SpO2 Reading</button>
    </div>

    <div class="section">
        <div class="data-display">
            ‚ù§Ô∏è Heart Rate: <span id="heartRate">--</span> bpm<br>
            üìä Average: <span id="avgHeartRate">--</span>
        </div>
        <div class="data-display">
            ü©∏ SpO2: <span id="spo2">--</span>%
        </div>
    </div>

    <div class="section">
        <h3>Debug Console</h3>
        <div id="debug-console"></div>
    </div>

    <script>
        const debugConsole = document.getElementById('debug-console');
        let heartRateReadings = [];
        let spo2Characteristic = null;

        function debugLog(message, isError = false) {
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            entry.style.color = isError ? '#ff4444' : '#00ff00';
            debugConsole.prepend(entry);
        }

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                debugLog('Initializing BLE connection...');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'WAVESTYLE_55A0' }],
                    optionalServices: [
                        '0000180d-0000-1000-8000-00805f9b34fb',
                        '00006287-3c17-d293-8e48-14fe2e4da212'
                    ]
                });

                debugLog(`Connected to: ${device.name}`);
                const server = await device.gatt.connect();
                debugLog('GATT connected');

                // Heart Rate Setup
                const hrService = await server.getPrimaryService('0000180d-0000-1000-8000-00805f9b34fb');
                const hrChar = await hrService.getCharacteristic('00002a37-0000-1000-8000-00805f9b34fb');
                await hrChar.startNotifications();
                hrChar.addEventListener('characteristicvaluechanged', processHR);
                debugLog('HR notifications enabled');

                // SpO2 Setup
                const spo2Service = await server.getPrimaryService('00006287-3c17-d293-8e48-14fe2e4da212');
                spo2Characteristic = await spo2Service.getCharacteristic('00006487-3c17-d293-8e48-14fe2e4da212');
                await spo2Characteristic.startNotifications();
                spo2Characteristic.addEventListener('characteristicvaluechanged', processSpO2);
                debugLog('SpO2 notifications enabled');
                
                document.getElementById('spo2Btn').disabled = false;

            } catch (error) {
                debugLog(`Connection error: ${error}`, true);
            }
        });

        document.getElementById('spo2Btn').addEventListener('click', async () => {
            try {
                debugLog('Triggering SpO2 measurement...');
                // Try different write commands based on common protocols
                const commands = [
                    new Uint8Array([0x01, 0x00]),  // Enable notifications
                    new Uint8Array([0x15, 0x00]),   // Start measurement
                    new Uint8Array([0xAA, 0x02])    // Custom command
                ];
                
                for (const cmd of commands) {
                    try {
                        await spo2Characteristic.writeValue(cmd);
                        debugLog(`Sent command: ${Array.from(cmd)}`);
                        break;
                    } catch (writeError) {
                        debugLog(`Command ${Array.from(cmd)} failed: ${writeError.message}`);
                    }
                }
            } catch (error) {
                debugLog(`SpO2 trigger error: ${error}`, true);
            }
        });

        function processHR(event) {
            try {
                const value = event.target.value;
                const flags = value.getUint8(0);
                const rate = flags & 0x01 ? value.getUint16(1, true) : value.getUint8(1);
                
                heartRateReadings.push(rate);
                heartRateReadings = heartRateReadings.slice(-30);
                document.getElementById('heartRate').textContent = rate;
                document.getElementById('avgHeartRate').textContent = 
                    (heartRateReadings.reduce((a, b) => a + b, 0) / heartRateReadings.length).toFixed(1);

            } catch (error) {
                debugLog(`HR processing error: ${error}`, true);
            }
        }

        function processSpO2(event) {
            try {
                const value = new Uint8Array(event.target.value.buffer);
                debugLog(`SPO2 RAW DATA: [${Array.from(value)}]`);

                // Try all possible byte positions and formats
                for (let i = 0; i < value.length; i++) {
                    const byteValue = value[i];
                    const wordValue = (value[i+1] << 8) | value[i];
                    
                    if (byteValue >= 70 && byteValue <= 100) {
                        document.getElementById('spo2').textContent = byteValue;
                        debugLog(`Found SpO2 at byte ${i}: ${byteValue}%`);
                        return;
                    }
                    
                    if (wordValue >= 7000 && wordValue <= 10000) {
                        document.getElementById('spo2').textContent = Math.round(wordValue/100);
                        debugLog(`Found SpO2 at bytes ${i}-${i+1}: ${wordValue/100}%`);
                        return;
                    }
                }

                debugLog('No valid SpO2 found in raw data. PLEASE SHARE THIS DATA!');

            } catch (error) {
                debugLog(`SpO2 processing error: ${error}`, true);
            }
        }
    </script>
</body>
</html>