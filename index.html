<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smartwatch Debugger</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #data { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        #debug { background: #000; color: #0f0; padding: 15px; font-family: monospace; }
    </style>
</head>
<body>
    <button id="connect">Connect Device</button>
    <div id="data">
        Heart Rate: <span id="hr">--</span> | 
        SpO2: <span id="spo2">--</span>
    </div>
    <div id="debug"></div>

    <script>
        const debug = document.getElementById('debug');
        let spo2Char = null;

        async function connectDevice() {
            try {
                log('Starting connection...');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'WAVESTYLE_55A0' }],
                    optionalServices: [
                        '0000180d-0000-1000-8000-00805f9b34fb',
                        '00006287-3c17-d293-8e48-14fe2e4da212',
                        '0000d0ff-3c17-d293-8e48-14fe2e4da212'
                    ]
                });

                log(`Connected to: ${device.name}`);
                const server = await device.gatt.connect();
                
                // Heart Rate
                const hrService = await server.getPrimaryService('0000180d-0000-1000-8000-00805f9b34fb');
                const hrChar = await hrService.getCharacteristic('00002a37-0000-1000-8000-00805f9b34fb');
                hrChar.addEventListener('characteristicvaluechanged', e => {
                    const value = e.target.value;
                    const rate = value.getUint8(1);
                    document.getElementById('hr').textContent = rate;
                });
                await hrChar.startNotifications();

                // Deep SpO2 Investigation
                await investigateSpo2(server);

            } catch (error) {
                log(`Error: ${error.message}`, true);
            }
        }

        async function investigateSpo2(server) {
            try {
                // Check all potential SpO2 services
                const services = [
                    '00006287-3c17-d293-8e48-14fe2e4da212',
                    '0000d0ff-3c17-d293-8e48-14fe2e4da212'
                ];

                for (const serviceUUID of services) {
                    try {
                        const service = await server.getPrimaryService(serviceUUID);
                        log(`Found service: ${serviceUUID}`);
                        
                        // Check all characteristics
                        const characteristics = await service.getCharacteristics();
                        characteristics.forEach(char => {
                            log(`Characteristic: ${char.uuid} [${char.properties.join(', ')}]`);
                            
                            // Check for notify capability
                            if (char.properties.includes('notify')) {
                                log('Found potential SpO2 characteristic!');
                                monitorCharacteristic(char);
                            }
                        });
                    } catch (error) {
                        log(`Service ${serviceUUID} error: ${error.message}`);
                    }
                }
            } catch (error) {
                log(`SpO2 investigation failed: ${error.message}`, true);
            }
        }

        async function monitorCharacteristic(char) {
            try {
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', e => {
                    const raw = new Uint8Array(e.target.value.buffer);
                    log(`DATA RECEIVED from ${char.uuid}: [${Array.from(raw)}]`);
                    document.getElementById('spo2').textContent = `RAW: ${Array.from(raw)}`;
                });
                log(`Monitoring ${char.uuid} successfully`);
            } catch (error) {
                log(`Monitor failed for ${char.uuid}: ${error.message}`);
            }
        }

        function log(message, isError = false) {
            const line = document.createElement('div');
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            line.style.color = isError ? '#f00' : '#0f0';
            debug.appendChild(line);
        }

        document.getElementById('connect').addEventListener('click', connectDevice);
    </script>
</body>
</html>