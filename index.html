<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOAT LEAP CALL Heart Rate Monitor - Dynamic Service Discovery</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f2f2f2;
            color: #333;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            background: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            margin: 5px;
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .status-box {
            margin: 20px 0;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-left: 5px solid #007bff;
        }

        .status-box h3 {
            margin-top: 0;
            color: #007bff;
        }

        #data, #averages, #minmax {
            margin: 20px 0;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        #data span, #averages span, #minmax span {
            font-weight: bold;
            color: #007bff;
        }

        #hrHistory {
            margin-top: 10px;
            font-size: 14px;
        }

        #debug {
            background: #000;
            color: #0f0;
            padding: 15px;
            font-family: monospace;
            height: 250px;
            overflow-y: auto;
            border-radius: 8px;
            margin-top: 20px;
        }

        .recent {
            color: #28a745 !important;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .success {
            color: #155724;
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .warning {
            color: #721c24;
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .step {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-left: 3px solid #28a745;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>BOAT LEAP CALL Heart Rate Monitor</h1>
    
    <div class="instructions">
        <h3>‚ö†Ô∏è IMPORTANT: Follow These Steps EXACTLY</h3>
        <div class="step">
            <strong>Step 1:</strong> On your BOAT LEAP CALL watch, go to <strong>Health ‚Üí Heart Rate</strong> and start measuring
        </div>
        <div class="step">
            <strong>Step 2:</strong> Keep the heart rate measurement <strong>actively running</strong> on the watch
        </div>
        <div class="step">
            <strong>Step 3:</strong> While heart rate is measuring, click "Connect & Monitor" below
        </div>
        <div class="step">
            <strong>Step 4:</strong> If connection fails, repeat the process keeping heart rate active longer
        </div>
    </div>

    <div class="status-box">
        <h3>Connection Status</h3>
        <div id="connectionStatus">Not Connected</div>
        <div id="serviceStatus">No services discovered</div>
        <div id="hrStatus">Heart rate service not found</div>
    </div>

    <button id="connectAndMonitor">Connect & Monitor Heart Rate</button>
    <button id="reconnect" disabled>Reconnect</button>
    <button id="forceDiscover" disabled>Force Rediscover Services</button>

    <div id="data">
        <div>Heart Rate: <span id="hr">--</span> bpm</div>
        <div>SpO2: <span id="spo2">--</span>%</div>
        <div id="hrHistory">Recent Heart Rates: <span id="hrList">--</span></div>
    </div>

    <div id="averages">
        <div>Average Heart Rate: <span id="avgHr">--</span> bpm</div>
        <div>Average SpO2: <span id="avgSpo2">--</span>%</div>
    </div>

    <div id="minmax">
        <div>Min Heart Rate: <span id="minHr">--</span> bpm</div>
        <div>Max Heart Rate: <span id="maxHr">--</span> bpm</div>
    </div>

    <div id="debug"></div>

    <script>
        const debug = document.getElementById('debug');
        let hrValues = [];
        let spo2Values = [];
        let minHr = Infinity;
        let maxHr = -Infinity;
        let emaHr = 0;
        const alpha = 0.2;
        let device = null;
        let server = null;
        let heartRateCharacteristic = null;
        let monitoringActive = false;

        function calculateEMA(currentValue, previousEMA) {
            if (previousEMA === 0) return currentValue;
            return alpha * currentValue + (1 - alpha) * previousEMA;
        }

        function updateStats() {
            const avg = arr => arr.length ? (arr.reduce((a, b) => a + b) / arr.length).toFixed(1) : '--';
            
            const recentHrValues = hrValues.slice(-10);
            if (recentHrValues.length > 0) {
                const hrListElement = document.getElementById('hrList');
                hrListElement.innerHTML = recentHrValues.map((val, idx) => 
                    idx === recentHrValues.length - 1 ? 
                    `<span class="recent">${val}</span>` : 
                    val
                ).join(', ');
            } else {
                document.getElementById('hrList').textContent = '--';
            }

            document.getElementById('avgSpo2').textContent = avg(spo2Values);

            if (hrValues.length > 0) {
                minHr = Math.min(...hrValues);
                maxHr = Math.max(...hrValues);
                document.getElementById('minHr').textContent = minHr;
                document.getElementById('maxHr').textContent = maxHr;
            }

            if (hrValues.length > 0) {
                const currentHr = hrValues[hrValues.length - 1];
                emaHr = calculateEMA(currentHr, emaHr);
                document.getElementById('avgHr').textContent = emaHr.toFixed(1);
            }
        }

        function updateStatus(connection, services, hr) {
            document.getElementById('connectionStatus').textContent = connection;
            document.getElementById('serviceStatus').textContent = services;
            document.getElementById('hrStatus').textContent = hr;
        }

        async function connectAndMonitor() {
            try {
                log('üîç Starting connection to BOAT LEAP CALL...');
                updateStatus('Connecting...', 'Waiting...', 'Waiting...');

                // Request device with heart rate service specifically
                device = await navigator.bluetooth.requestDevice({
                    filters: [
                        { namePrefix: 'LEAP' },
                        { namePrefix: 'BOAT' },
                        { services: ['heart_rate'] }
                    ],
                    acceptAllDevices: false,
                    optionalServices: [
                        'heart_rate',
                        'battery_service',
                        'device_information',
                        'generic_access',
                        'generic_attribute',
                        '0000180d-0000-1000-8000-00805f9b34fb', // Heart Rate
                        '0000180f-0000-1000-8000-00805f9b34fb', // Battery
                        '0000180a-0000-1000-8000-00805f9b34fb', // Device Info
                        '00001800-0000-1000-8000-00805f9b34fb', // Generic Access
                        '00001801-0000-1000-8000-00805f9b34fb', // Generic Attribute
                        '0000181c-0000-1000-8000-00805f9b34fb'  // User Data
                    ]
                });

                log(`‚úÖ Connected to: ${device.name}`);
                updateStatus(`Connected to ${device.name}`, 'Discovering services...', 'Searching...');

                server = await device.gatt.connect();
                log('‚úÖ GATT server connected');

                // Enable buttons
                document.getElementById('reconnect').disabled = false;
                document.getElementById('forceDiscover').disabled = false;

                // Start heart rate monitoring
                await findAndStartHeartRateMonitoring();

            } catch (error) {
                log(`‚ùå Connection error: ${error.message}`, true);
                updateStatus('Connection Failed', error.message, 'Not available');
                
                if (error.message.includes('User cancelled')) {
                    log('üí° Tip: Make sure to select your BOAT LEAP CALL from the list', false);
                } else if (error.message.includes('No Services')) {
                    log('üí° Tip: Start heart rate measurement on your watch FIRST, then try connecting again', false);
                }
            }
        }

        async function findAndStartHeartRateMonitoring() {
            try {
                log('üîç Discovering all available services...');
                
                // Get all services
                const services = await server.getPrimaryServices();
                log(`üìã Found ${services.length} services`);
                updateStatus('Connected', `${services.length} services found`, 'Searching for heart rate...');

                // First try standard heart rate service
                let heartRateService = null;
                
                for (const service of services) {
                    log(`üîç Service: ${service.uuid}`);
                    
                    if (service.uuid === '0000180d-0000-1000-8000-00805f9b34fb' || 
                        service.uuid.includes('180d')) {
                        heartRateService = service;
                        log('üéØ Found heart rate service!');
                        break;
                    }
                }

                if (heartRateService) {
                    await setupHeartRateMonitoring(heartRateService);
                } else {
                    log('‚ö†Ô∏è Standard heart rate service not found. This means:');
                    log('1. Heart rate is not actively measuring on the watch');
                    log('2. Watch needs to be in heart rate measurement mode');
                    log('3. Try starting heart rate on watch, then click "Force Rediscover"');
                    updateStatus('Connected', 'Services found', 'Heart rate service not available');
                    
                    // Try alternative approach - look for any characteristics that might contain heart rate data
                    await tryAlternativeHeartRateDetection(services);
                }

            } catch (error) {
                log(`‚ùå Service discovery error: ${error.message}`, true);
                updateStatus('Connected', 'Service discovery failed', 'Not available');
            }
        }

        async function setupHeartRateMonitoring(heartRateService) {
            try {
                log('üîß Setting up heart rate monitoring...');
                const characteristics = await heartRateService.getCharacteristics();
                
                for (const characteristic of characteristics) {
                    log(`üì° Characteristic: ${characteristic.uuid}`);
                    
                    if (characteristic.uuid === '00002a37-0000-1000-8000-00805f9b34fb' || 
                        characteristic.uuid.includes('2a37')) {
                        
                        heartRateCharacteristic = characteristic;
                        
                        characteristic.addEventListener('characteristicvaluechanged', handleHeartRateData);
                        await characteristic.startNotifications();
                        
                        monitoringActive = true;
                        log('üéâ Heart rate monitoring started successfully!');
                        updateStatus('Connected & Monitoring', 'Heart rate service active', 'Receiving data');
                        return;
                    }
                }
                
                log('‚ùå Heart rate measurement characteristic not found');
                updateStatus('Connected', 'Heart rate service found', 'Measurement characteristic missing');
                
            } catch (error) {
                log(`‚ùå Heart rate setup error: ${error.message}`, true);
                updateStatus('Connected', 'Heart rate service found', 'Setup failed');
            }
        }

        async function tryAlternativeHeartRateDetection(services) {
            log('üîç Trying alternative heart rate detection...');
            
            for (const service of services) {
                try {
                    const characteristics = await service.getCharacteristics();
                    
                    for (const characteristic of characteristics) {
                        if (characteristic.properties.notify) {
                            log(`üì° Monitoring notify characteristic: ${characteristic.uuid} in service ${service.uuid}`);
                            
                            characteristic.addEventListener('characteristicvaluechanged', (event) => {
                                handlePossibleHeartRateData(event, characteristic.uuid);
                            });
                            
                            try {
                                await characteristic.startNotifications();
                                log(`‚úÖ Notifications started for ${characteristic.uuid}`);
                            } catch (notifyError) {
                                log(`‚ö†Ô∏è Could not start notifications for ${characteristic.uuid}: ${notifyError.message}`);
                            }
                        }
                    }
                } catch (serviceError) {
                    log(`‚ö†Ô∏è Could not access service ${service.uuid}: ${serviceError.message}`);
                }
            }
        }

        function handleHeartRateData(event) {
            const value = event.target.value;
            const raw = new Uint8Array(value.buffer);
            
            log(`üìä Heart rate data: [${Array.from(raw).join(', ')}]`);
            
            // Standard Bluetooth heart rate format
            const flags = raw[0];
            const is16Bit = flags & 0x01;
            const heartRate = is16Bit ? value.getUint16(1, true) : raw[1];
            
            if (heartRate >= 40 && heartRate <= 220) {
                updateHeartRateDisplay(heartRate);
                log(`üíó Heart rate: ${heartRate} bpm`);
            } else {
                log(`‚ö†Ô∏è Invalid heart rate value: ${heartRate}`);
            }
        }

        function handlePossibleHeartRateData(event, charUuid) {
            const value = event.target.value;
            const raw = new Uint8Array(value.buffer);
            
            log(`üì° Data from ${charUuid}: [${Array.from(raw).join(', ')}]`);
            
            // Look for potential heart rate values
            for (let i = 0; i < raw.length; i++) {
                const testValue = raw[i];
                if (testValue >= 40 && testValue <= 220) {
                    log(`ü§î Possible heart rate at byte ${i}: ${testValue}`);
                    updateHeartRateDisplay(testValue);
                    break;
                }
            }
        }

        function updateHeartRateDisplay(heartRate) {
            document.getElementById('hr').textContent = heartRate;
            hrValues.push(heartRate);
            if (hrValues.length > 10) hrValues.shift();
            
            emaHr = calculateEMA(heartRate, emaHr);
            document.getElementById('avgHr').textContent = emaHr.toFixed(1);
            
            updateStats();
            
            if (!monitoringActive) {
                updateStatus('Connected & Receiving', 'Alternative method active', 'Data flowing');
                monitoringActive = true;
            }
        }

        async function reconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
            await connectAndMonitor();
        }

        async function forceRediscover() {
            if (server) {
                log('üîÑ Force rediscovering services...');
                await findAndStartHeartRateMonitoring();
            } else {
                log('‚ùå Not connected to device');
            }
        }

        function log(message, isError = false) {
            const line = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            line.style.color = isError ? '#f00' : '#0f0';
            debug.appendChild(line);
            debug.scrollTop = debug.scrollHeight;
        }

        // Event listeners
        document.getElementById('connectAndMonitor').addEventListener('click', connectAndMonitor);
        document.getElementById('reconnect').addEventListener('click', reconnect);
        document.getElementById('forceDiscover').addEventListener('click', forceRediscover);

        // Handle device disconnection
        document.addEventListener('DOMContentLoaded', () => {
            log('üöÄ App loaded. Make sure heart rate is measuring on your watch!');
        });
    </script>
</body>
</html>