<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smartwatch Health Monitor</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .section { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .data-display { font-size: 24px; margin: 10px 0; }
        button { padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #debug-console { background: #111; color: #0f0; padding: 10px; font-family: monospace; max-height: 200px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Smartwatch Health Monitor</h1>
    
    <div class="section">
        <h2>Device Connection</h2>
        <button id="connectBtn">Connect to Smartwatch</button>
        <div id="device-info"></div>
    </div>
    
    <div class="section">
        <h2>Health Data</h2>
        <div class="data-display">‚ù§Ô∏è Heart Rate: <span id="heartRate">--</span> bpm (Avg: <span id="avgHeartRate">--</span>)</div>
        <div class="data-display">ü©∏ SpO2: <span id="spo2">--</span>%</div>
    </div>
    
    <div class="section">
        <h2>Debug Console</h2>
        <div id="debug-console"></div>
    </div>

    <script>
        const debugConsole = document.getElementById('debug-console');
        let heartRateReadings = [];
        
        // Debug logging
        function log(message, isError = false) {
            const line = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugConsole.innerHTML += (isError ? `<span class="error">${line}</span>` : line) + '\n';
            debugConsole.scrollTop = debugConsole.scrollHeight;
        }

        // BLE Configuration
        const BLE_CONFIG = {
            deviceName: 'WAVESTYLE_55A0',
            services: {
                heartRate: '0000180d-0000-1000-8000-00805f9b34fb',
                spo2: '0000d0ff-3c17-d293-8e48-14fe2e4da212'
            },
            characteristics: {
                heartRateMeasurement: '00002a37-0000-1000-8000-00805f9b34fb',
                spo2Candidates: [
                    '0000fff1-0000-1000-8000-00805f9b34fb',
                    '0000fff2-0000-1000-8000-00805f9b34fb',
                    '0000ffd2-0000-1000-8000-00805f9b34fb'
                ]
            }
        };

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                log('Initializing connection...');
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: BLE_CONFIG.deviceName }],
                    optionalServices: Object.values(BLE_CONFIG.services)
                });

                log(`Connected to device: ${device.name}`);
                device.addEventListener('gattserverdisconnected', () => log('Device disconnected'));

                const server = await device.gatt.connect();
                log('GATT server connected');

                // Setup heart rate monitoring
                try {
                    const hrService = await server.getPrimaryService(BLE_CONFIG.services.heartRate);
                    const hrChar = await hrService.getCharacteristic(BLE_CONFIG.characteristics.heartRateMeasurement);
                    await hrChar.startNotifications();
                    hrChar.addEventListener('characteristicvaluechanged', processHeartRate);
                    log('Heart rate monitoring enabled');
                } catch (hrError) {
                    log(`Heart rate setup failed: ${hrError.message}`, true);
                }

                // Setup SpO2 monitoring
                try {
                    const spo2Service = await server.getPrimaryService(BLE_CONFIG.services.spo2);
                    
                    for (const charUUID of BLE_CONFIG.characteristics.spo2Candidates) {
                        try {
                            const spo2Char = await spo2Service.getCharacteristic(charUUID);
                            await spo2Char.startNotifications();
                            spo2Char.addEventListener('characteristicvaluechanged', processSpO2);
                            log(`Subscribed to SpO2 characteristic: ${charUUID}`);
                            break;
                        } catch (charError) {
                            log(`Skipping characteristic ${charUUID}: ${charError.message}`);
                        }
                    }
                } catch (spo2Error) {
                    log(`SpO2 setup failed: ${spo2Error.message}`, true);
                }

            } catch (error) {
                log(`Connection failed: ${error.message}`, true);
            }
        });

        function processHeartRate(event) {
            try {
                const value = event.target.value;
                const flags = value.getUint8(0);
                const rate = flags & 0x01 ? value.getUint16(1, true) : value.getUint8(1);
                
                document.getElementById('heartRate').textContent = rate;
                heartRateReadings = [...heartRateReadings.slice(-99), rate];
                
                const avg = heartRateReadings.reduce((a, b) => a + b, 0) / heartRateReadings.length;
                document.getElementById('avgHeartRate').textContent = avg.toFixed(1);
                
                log(`Heart rate update: ${rate} bpm (Avg: ${avg.toFixed(1)})`);

            } catch (error) {
                log(`Heart rate processing error: ${error.message}`, true);
            }
        }

        function processSpO2(event) {
            try {
                const value = new DataView(event.target.value.buffer);
                let spo2Value = null;

                // Try different data formats
                if (value.byteLength >= 2) {
                    spo2Value = value.getUint8(1);  // Most common position
                    if (spo2Value < 70 || spo2Value > 100) spo2Value = null;
                }

                if (!spo2Value && value.byteLength >= 3) {
                    spo2Value = value.getUint8(2);  // Alternative position
                    if (spo2Value < 70 || spo2Value > 100) spo2Value = null;
                }

                if (!spo2Value && value.byteLength >= 4) {
                    const rawValue = value.getUint16(2, true);
                    if (rawValue >= 7000 && rawValue <= 10000) {
                        spo2Value = rawValue / 100;
                    }
                }

                if (spo2Value) {
                    document.getElementById('spo2').textContent = Number(spo2Value).toFixed(0);
                    log(`SpO2 update: ${spo2Value}%`);
                } else {
                    log(`Unrecognized SpO2 format: ${Array.from(new Uint8Array(event.target.value.buffer))}`);
                }

            } catch (error) {
                log(`SpO2 processing error: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>