<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Keep the same CSS styles from previous version -->
    <style>
        /* Previous CSS styles remain unchanged */
    </style>
</head>
<body>
    <!-- Keep the same HTML structure from previous version -->
    <!-- Add debug section -->
    <div class="section">
        <h2>Debug Information</h2>
        <div id="debug-console" style="white-space: pre-wrap;"></div>
    </div>

    <script>
        // DOM elements
        const connectBtn = document.getElementById('connectBtn');
        const deviceInfo = document.getElementById('device-info');
        const servicesList = document.getElementById('services-list');
        const heartRateDisplay = document.getElementById('heartRate');
        const avgHeartRateDisplay = document.getElementById('avgHeartRate');
        const hrCountDisplay = document.getElementById('hrCount');
        const spo2Display = document.getElementById('spo2');
        const debugConsole = document.getElementById('debug-console');
        
        // BLE variables
        let device;
        let heartRateCharacteristic;
        let spo2Characteristic;
        
        // Data storage
        let heartRateReadings = [];
        const MAX_READINGS = 100;
        
        // UUIDs
        const HEART_RATE_SERVICE_UUID = '0000180d-0000-1000-8000-00805f9b34fb';
        const HEART_RATE_MEASUREMENT_UUID = '00002a37-0000-1000-8000-00805f9b34fb';
        const SPO2_SERVICE_UUID = '0000d0ff-3c17-d293-8e48-14fe2e4da212';
        const SPO2_CHARACTERISTICS = [
            '0000fff1-0000-1000-8000-00805f9b34fb',
            '0000fff2-0000-1000-8000-00805f9b34fb',
            '0000fff3-0000-1000-8000-00805f9b34fb',
            '0000ffd2-0000-1000-8000-00805f9b34fb'
        ];

        // Debug logging
        function logDebug(message) {
            debugConsole.textContent += `${new Date().toLocaleTimeString()}: ${message}\n`;
            console.log(message);
        }

        // Connect to device
        connectBtn.addEventListener('click', async () => {
            try {
                logDebug('Starting device connection...');
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'WAVESTYLE_55A0' }],
                    optionalServices: [
                        HEART_RATE_SERVICE_UUID,
                        SPO2_SERVICE_UUID,
                        '00006287-3c17-d293-8e48-14fe2e4da212'
                    ]
                });
                
                logDebug(`Connected to device: ${device.name}`);
                deviceInfo.innerHTML = `
                    <p>Connected to: <strong>${device.name}</strong></p>
                    <p>ID: ${device.id}</p>
                `;
                
                device.addEventListener('gattserverdisconnected', () => {
                    logDebug('Device disconnected');
                    deviceInfo.innerHTML += '<p style="color: red;">Device disconnected</p>';
                });
                
                const server = await device.gatt.connect();
                logDebug('GATT server connected');
                
                await setupHeartRateMonitoring(server);
                await setupSpo2Monitoring(server);
                
            } catch (error) {
                logDebug(`Connection error: ${error}`);
                deviceInfo.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        });

        async function setupHeartRateMonitoring(server) {
            try {
                logDebug('Setting up heart rate monitoring...');
                const service = await server.getPrimaryService(HEART_RATE_SERVICE_UUID);
                heartRateCharacteristic = await service.getCharacteristic(HEART_RATE_MEASUREMENT_UUID);
                
                logDebug('Enabling heart rate notifications...');
                await heartRateCharacteristic.startNotifications();
                heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRateMeasurement);
                logDebug('Heart rate notifications enabled');
                
            } catch (error) {
                logDebug(`Heart rate setup error: ${error}`);
            }
        }

        function handleHeartRateMeasurement(event) {
            try {
                const value = event.target.value;
                logDebug(`HR Raw: ${Array.from(new Uint8Array(value.buffer))}`);
                
                const flags = value.getUint8(0);
                const rate = flags & 0x01 ? value.getUint16(1, true) : value.getUint8(1);
                
                heartRateDisplay.textContent = rate;
                heartRateReadings.push(rate);
                
                if (heartRateReadings.length > MAX_READINGS) {
                    heartRateReadings.shift();
                }
                
                const avg = heartRateReadings.length > 0 
                    ? (heartRateReadings.reduce((a, b) => a + b, 0) / heartRateReadings.length).toFixed(2)
                    : 0;
                    
                avgHeartRateDisplay.textContent = avg;
                hrCountDisplay.textContent = heartRateReadings.length;
                
            } catch (error) {
                logDebug(`HR Processing error: ${error}`);
            }
        }

        async function setupSpo2Monitoring(server) {
            try {
                logDebug('Setting up SpO2 monitoring...');
                const service = await server.getPrimaryService(SPO2_SERVICE_UUID);
                
                for (const uuid of SPO2_CHARACTERISTICS) {
                    try {
                        logDebug(`Trying characteristic ${uuid}`);
                        const characteristic = await service.getCharacteristic(uuid);
                        
                        // Enable notifications
                        await characteristic.startNotifications();
                        characteristic.addEventListener('characteristicvaluechanged', handleSpo2Measurement);
                        
                        // Some devices require initialization
                        try {
                            await characteristic.writeValue(new Uint8Array([0x01, 0x00]));
                            logDebug(`Enabled notifications for ${uuid}`);
                        } catch (writeError) {
                            logDebug(`Notification enable write failed for ${uuid}: ${writeError}`);
                        }
                        
                        logDebug(`Subscribed to ${uuid}`);
                        return;
                        
                    } catch (error) {
                        logDebug(`Characteristic ${uuid} failed: ${error}`);
                    }
                }
                
                logDebug('No SpO2 characteristics found');
                
            } catch (error) {
                logDebug(`SpO2 setup error: ${error}`);
            }
        }

        function handleSpo2Measurement(event) {
            try {
                const value = event.target.value;
                const data = new Uint8Array(value.buffer);
                logDebug(`SpO2 Raw: ${Array.from(data)}`);
                
                // Try different data formats
                if (data.length >= 2) {
                    const spo2 = data[1];
                    if (spo2 >= 70 && spo2 <= 100) {
                        spo2Display.textContent = spo2;
                        return;
                    }
                }
                
                if (data.length >= 3) {
                    const spo2 = data[2];
                    if (spo2 >= 70 && spo2 <= 100) {
                        spo2Display.textContent = spo2;
                        return;
                    }
                }
                
                if (data.length >= 4) {
                    const spo16 = new DataView(value.buffer).getUint16(2, true);
                    if (spo16 >= 7000 && spo16 <= 10000) {
                        spo2Display.textContent = (spo16 / 100).toFixed(1);
                        return;
                    }
                }
                
                logDebug(`Unrecognized SpO2 format: ${data}`);
                
            } catch (error) {
                logDebug(`SpO2 Processing error: ${error}`);
            }
        }
    </script>
</body>
</html>