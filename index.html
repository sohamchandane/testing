<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smartwatch Monitor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .data-display {
            font-size: 24px;
            margin: 10px 0;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        #device-info {
            font-family: monospace;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Smartwatch Monitor</h1>
    
    <div class="section">
        <h2>Device Connection</h2>
        <button id="connectBtn">Connect to Smartwatch</button>
        <div id="device-info"></div>
    </div>
    
    <div class="section">
        <h2>Available Services & Characteristics</h2>
        <div id="services-list"></div>
    </div>
    
    <div class="section">
        <h2>Heart Rate Monitoring</h2>
        <div class="data-display">Current Heart Rate: <span id="heartRate">--</span> bpm</div>
        <div class="data-display">Average Heart Rate: <span id="avgHeartRate">--</span> bpm</div>
        <div>Readings Count: <span id="hrCount">0</span></div>
    </div>
    
    <div class="section">
        <h2>SpO2 Monitoring</h2>
        <div class="data-display">Current SpO2: <span id="spo2">--</span>%</div>
    </div>

    <script>
        // DOM elements
        const connectBtn = document.getElementById('connectBtn');
        const deviceInfo = document.getElementById('device-info');
        const servicesList = document.getElementById('services-list');
        const heartRateDisplay = document.getElementById('heartRate');
        const avgHeartRateDisplay = document.getElementById('avgHeartRate');
        const hrCountDisplay = document.getElementById('hrCount');
        const spo2Display = document.getElementById('spo2');
        
        // BLE variables
        let device;
        let heartRateService;
        let heartRateCharacteristic;
        let spo2Characteristic;
        
        // Data storage
        let heartRateReadings = [];
        const MAX_READINGS = 100;
        
        // UUIDs
        const HEART_RATE_SERVICE_UUID = '0000180d-0000-1000-8000-00805f9b34fb';
        const HEART_RATE_MEASUREMENT_UUID = '00002a37-0000-1000-8000-00805f9b34fb';
        const SPO2_SERVICE_UUID = '0000d0ff-3c17-d293-8e48-14fe2e4da212';
        const SPO2_CHARACTERISTIC_UUID = '0000fff1-0000-1000-8000-00805f9b34fb';
        
        // Connect to device
        connectBtn.addEventListener('click', async () => {
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'WAVESTYLE_55A0' }],
                    optionalServices: [
                        HEART_RATE_SERVICE_UUID,
                        SPO2_SERVICE_UUID
                    ]
                });
                
                deviceInfo.innerHTML = `
                    <p>Connected to: <strong>${device.name}</strong></p>
                    <p>ID: ${device.id}</p>
                `;
                
                device.addEventListener('gattserverdisconnected', onDisconnected);
                
                const server = await device.gatt.connect();
                const services = await server.getPrimaryServices();
                
                displayServices(services);
                await setupHeartRateMonitoring(server);
                await setupSpo2Monitoring(server);
                
            } catch (error) {
                console.error('Error:', error);
                deviceInfo.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        });
        
        function onDisconnected() {
            deviceInfo.innerHTML += '<p style="color: red;">Device disconnected</p>';
        }
        
        function displayServices(services) {
            let html = '<table>';
            html += '<tr><th>Service UUID</th><th>Characteristics</th></tr>';
            
            services.forEach(service => {
                html += `<tr><td>${service.uuid}</td><td><ul>`;
                
                if (service.uuid === HEART_RATE_SERVICE_UUID) {
                    html += `<li>00002a37-0000-1000-8000-00805f9b34fb (Heart Rate Measurement)</li>`;
                    html += `<li>00002a38-0000-1000-8000-00805f9b34fb (Body Sensor Location)</li>`;
                    html += `<li>00002a39-0000-1000-8000-00805f9b34fb (Heart Rate Control Point)</li>`;
                } else if (service.uuid === SPO2_SERVICE_UUID) {
                    html += `<li>0000ffd1-0000-1000-8000-00805f9b34fb</li>`;
                    html += `<li>0000ffd2-0000-1000-8000-00805f9b34fb</li>`;
                    html += `<li>0000ffd3-0000-1000-8000-00805f9b34fb</li>`;
                    html += `<li>0000ffd4-0000-1000-8000-00805f9b34fb</li>`;
                    html += `<li>0000ffd5-0000-1000-8000-00805f9b34fb</li>`;
                    html += `<li>0000ffd8-0000-1000-8000-00805f9b34fb</li>`;
                    html += `<li>0000ffe0-0000-1000-8000-00805f9b34fb</li>`;
                    html += `<li>0000fff1-0000-1000-8000-00805f9b34fb (SpO2)</li>`;
                    html += `<li>0000fff2-0000-1000-8000-00805f9b34fb</li>`;
                    html += `<li>0000fff3-0000-1000-8000-00805f9b34fb</li>`;
                } else {
                    html += `<li>Custom Service Characteristics</li>`;
                }
                
                html += '</ul></td></tr>';
            });
            
            html += '</table>';
            servicesList.innerHTML = html;
        }
        
        async function setupHeartRateMonitoring(server) {
            heartRateService = await server.getPrimaryService(HEART_RATE_SERVICE_UUID);
            heartRateCharacteristic = await heartRateService.getCharacteristic(HEART_RATE_MEASUREMENT_UUID);
            
            await heartRateCharacteristic.startNotifications();
            heartRateCharacteristic.addEventListener('characteristicvaluechanged', handleHeartRateMeasurement);
        }
        
        function handleHeartRateMeasurement(event) {
            const value = event.target.value;
            const flags = value.getUint8(0);
            let rate;
            
            if (flags & 0x1) {
                rate = value.getUint16(1, true);
            } else {
                rate = value.getUint8(1);
            }
            
            heartRateDisplay.textContent = rate;
            
            heartRateReadings.push(rate);
            if (heartRateReadings.length > MAX_READINGS) {
                heartRateReadings.shift();
            }
            
            const sum = heartRateReadings.reduce((a, b) => a + b, 0);
            const avg = sum / heartRateReadings.length;
            
            avgHeartRateDisplay.textContent = avg.toFixed(2);
            hrCountDisplay.textContent = heartRateReadings.length;
        }
        
        async function setupSpo2Monitoring(server) {
            try {
                const spo2Service = await server.getPrimaryService(SPO2_SERVICE_UUID);
                spo2Characteristic = await spo2Service.getCharacteristic(SPO2_CHARACTERISTIC_UUID);
                
                await spo2Characteristic.startNotifications();
                
                // Some devices require this to start sending data
                try {
                    await spo2Characteristic.writeValue(new Uint8Array([0x01, 0x00]));
                } catch (error) {
                    console.log('Notifications already enabled');
                }
                
                spo2Characteristic.addEventListener('characteristicvaluechanged', handleSpo2Measurement);
            } catch (error) {
                console.error('SpO2 setup error:', error);
            }
        }
        
        function handleSpo2Measurement(event) {
            const value = event.target.value;
            console.log('SpO2 Raw Data:', new Uint8Array(value.buffer));
            
            // Try different data formats
            if (value.byteLength >= 2) {
                const spo2Value = value.getUint8(1);
                if (spo2Value >= 70 && spo2Value <= 100) {
                    spo2Display.textContent = spo2Value;
                    return;
                }
            }
            
            if (value.byteLength >= 4) {
                const spo2Value = value.getUint16(2, true);
                if (spo2Value >= 7000 && spo2Value <= 10000) {
                    spo2Display.textContent = (spo2Value / 100).toFixed(1);
                    return;
                }
            }
            
            console.warn('Unrecognized SpO2 format:', value);
        }
    </script>
</body>
</html>